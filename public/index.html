<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ONLINETRADERZ â€” Shop</title>
<meta name="color-scheme" content="light dark" />
<style>
  /* =========================
     Variables & Base
     ========================= */
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --muted: #6b7280;
    --accent: #25d366;
    --accent-600: #1fa34f;
    --glass: rgba(255,255,255,0.6);
    --glass-2: rgba(5,32,74,0.04);
    --text: #051029;
    --radius: 14px;
    --shadow-sm: 0 6px 18px rgba(10,12,20,0.06);
    --shadow-lg: 0 24px 60px rgba(2,6,23,0.10);
    --max-width: 1200px;
    --nav-height: 72px;
    --glass-border: 1px solid rgba(15,23,42,0.06);
    transition: 250ms ease;
  }

  /* Dark theme variables (applied with .theme-dark on body) */
  .theme-dark {
    --bg: #05060a;
    --card: #0b1220;
    --muted: #9aa3b2;
    --accent: #2dd17b;
    --accent-600: #14b04e;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --text: #e6eef7;
    --glass-border: 1px solid rgba(255,255,255,0.04);
    --shadow-sm: 0 8px 26px rgba(2,6,23,0.45);
    --shadow-lg: 0 40px 90px rgba(2,6,23,0.6);
  }

  /* =========================
     Reset & base typography
     ========================= */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  a{color:inherit}
  img{max-width:100%;display:block}
  button{font:inherit}

  /* =========================
     Page layout
     ========================= */
  .wrap{max-width:var(--max-width);margin:0 auto;padding:20px 20px 80px}
  header.site-header{
    position:sticky;top:12px;z-index:60;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));backdrop-filter: blur(8px);border-radius:18px;border:var(--glass-border);box-shadow:var(--shadow-sm);margin:8px 12px;display:flex;align-items:center;justify-content:space-between;height:var(--nav-height);
  }
  .hdr-left{display:flex;align-items:center;gap:14px}
  .logo{
    font-weight:800;font-size:1.1rem;letter-spacing:0.6px;color:var(--text);
    display:flex;align-items:center;gap:10px;
  }
  .logo-badge{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--accent),var(--accent-600));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;box-shadow:0 8px 20px rgba(37,211,102,0.12)}
  .tagline{font-size:0.9rem;color:var(--muted);font-weight:600}

  nav.main-nav{display:flex;gap:10px;align-items:center}
  nav.main-nav a{padding:8px 12px;border-radius:10px;text-decoration:none;color:var(--muted);font-weight:700}
  nav.main-nav a:hover{background:var(--glass-2);color:var(--text)}

  .controls{display:flex;gap:10px;align-items:center}
  .theme-toggle{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:12px;background:transparent;border:0;cursor:pointer}
  .cart-btn{position:relative;background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800;box-shadow:0 8px 26px rgba(37,211,102,0.12)}
  .cart-count{position:absolute;top:-8px;right:-8px;background:var(--card);color:var(--text);border-radius:999px;padding:4px 8px;font-weight:800;font-size:13px;border:var(--glass-border)}

  /* =========================
     Hero
     ========================= */
  .hero{
    display:grid;grid-template-columns:1fr 360px;gap:28px;align-items:center;margin:28px 12px;padding:26px;border-radius:20px;background:linear-gradient(180deg,var(--card),rgba(0,0,0,0));box-shadow:var(--shadow-lg);border:var(--glass-border);
  }
  .hero h1{margin:0;font-size:clamp(22px,3.6vw,36px);line-height:1.02}
  .hero p{margin:12px 0;color:var(--muted);max-width:52ch}
  .hero-cta{display:flex;gap:12px;margin-top:12px}
  .btn{padding:12px 18px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
  .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;box-shadow:0 12px 30px rgba(37,211,102,0.12)}
  .btn-ghost{background:transparent;border:1px solid var(--glass-2);color:var(--text)}

  .hero-banner{width:100%;height:220px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#f8fafc,#fff);box-shadow:var(--shadow-sm)}
  .hero-banner img{width:100%;height:100%;object-fit:cover}

  /* =========================
     Products grid
     ========================= */
  .section-head{display:flex;justify-content:space-between;align-items:end;gap:12px;margin:16px 12px}
  .products-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin:10px 12px}
  .card{
    background:var(--card);border-radius:16px;padding:14px;box-shadow:var(--shadow-sm);display:flex;flex-direction:column;transition:transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s;
    border:var(--glass-border);
  }
  .card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(2,6,23,0.08)}
  .img-wrap{height:200px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#f8fafc,#fff);display:flex;align-items:center;justify-content:center}
  .img-wrap img{max-width:100%;max-height:100%;object-fit:contain}
  .card h3{margin:12px 0 6px;font-size:1.02rem}
  .price{font-weight:900;color:var(--text);margin-bottom:8px}
  .meta-muted{color:var(--muted);font-size:0.92rem;margin-bottom:8px}

  .actions{display:flex;gap:10px;margin-top:auto}
  .add-btn{flex:1;padding:10px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;font-weight:800;cursor:pointer}
  .wa-btn{flex:1;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--text);border:1px solid var(--glass-2);cursor:pointer;font-weight:800}

  /* =========================
     Pagination
     ========================= */
  .pagination{display:flex;justify-content:center;gap:8px;margin:22px 0}
  .pagination button{padding:8px 12px;border-radius:10px;border:1px solid var(--glass-2);background:transparent;cursor:pointer}

  /* =========================
     Modals
     ========================= */
  .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.48);z-index:500;align-items:center;justify-content:center;padding:20px}
  .modal.open{display:flex}
  .modal-card{background:var(--card);width:100%;max-width:820px;padding:22px;border-radius:16px;box-shadow:var(--shadow-lg);position:relative;border:var(--glass-border);max-height:92vh;overflow:auto}
  .modal .close{position:absolute;top:12px;right:16px;background:transparent;border:0;font-size:22px;cursor:pointer;color:var(--muted)}

  /* cart */
  .cart-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px}
  .cart-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;border:1px solid var(--glass-2)}
  .cart-item img{width:84px;height:72px;object-fit:cover;border-radius:10px}
  .qty-controls{display:flex;align-items:center;gap:8px}
  .qty-controls button{width:30px;height:30px;border-radius:8px;border:1px solid var(--glass-2);background:transparent;cursor:pointer}

  /* footer */
  footer.site-footer{margin-top:36px;background:var(--card);padding:18px;border-radius:14px;box-shadow:var(--shadow-sm);text-align:center;color:var(--muted);border:var(--glass-border);margin:16px 12px}
  footer a{color:var(--accent);font-weight:800;text-decoration:none}

  /* small screens */
  @media (max-width:1000px){ .products-grid{grid-template-columns:repeat(3,1fr)} .hero{grid-template-columns:1fr 1fr} }
  @media (max-width:760px){ .products-grid{grid-template-columns:repeat(2,1fr)} .hero{grid-template-columns:1fr} .hero-banner{height:180px} nav.main-nav{display:none} }
  @media (max-width:420px){ .products-grid{grid-template-columns:1fr} .logo{font-size:1rem} .hdr-left .tagline{display:none} .hero-banner{height:160px} }

  /* subtle transitions and focus states */
  input,textarea,select,button{transition:box-shadow .18s,transform .12s}
  input:focus,textarea:focus{outline:none;box-shadow:0 6px 20px rgba(37,211,102,0.12);border-color:var(--accent-600)}

  /* Preloader */
  #preloader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .35s}
  .spinner{width:72px;height:72px;border-radius:18px;background:linear-gradient(180deg,var(--card),var(--glass));display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-lg);border:var(--glass-border)}
  .spinner:before{content:"";width:40px;height:40px;border-radius:10px;border:4px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* utility */
  .small{font-size:0.92rem;color:var(--muted)}
  .sr-only{position:absolute;left:-9999px}
</style>
</head>
<body>
  <!-- Preloader -->
  <div id="preloader" aria-hidden="false">
    <div class="spinner" role="status" aria-label="Loading"></div>
  </div>

  <!-- Header -->
  <header class="site-header" role="banner" aria-label="Main header">
    <div class="hdr-left" style="gap:12px">
      <div class="logo" aria-hidden="false">
        <div class="logo-badge" aria-hidden="true">OT</div>
        <div style="display:flex;flex-direction:column;line-height:1">
          <div style="font-weight:800">ONLINETRADERZ</div>
          <div class="tagline">Quality goods â€¢ Fast delivery</div>
        </div>
      </div>
    </div>

    <nav class="main-nav" role="navigation" aria-label="Primary navigation">
      <a href="/">Home</a>
      <a href="#shop">Shop</a>
      <a href="#contact">Contact</a>
      <a href="#about">About</a>
    </nav>

    <div class="controls" role="toolbar" aria-label="Controls">
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">Theme</button>
      <button class="cart-btn" onclick="openCart()" aria-haspopup="dialog">
        Cart <span id="cartCount" class="cart-count">0</span>
      </button>
    </div>
  </header>

  <main class="wrap" id="main">
    <!-- Hero -->
    <section class="hero" aria-label="Hero">
      <div>
        <h1>Shop easy. Ship fast. Smile more.</h1>
        <p>Curated selection of products you can trust. Fast cash-on-delivery and printable shipping labels for every order.</p>
        <div class="hero-cta">
          <button class="btn btn-primary" onclick="scrollToProducts()">Shop Now</button>
          <button class="btn btn-ghost" onclick="openCart()">View Cart</button>
        </div>
        <div style="margin-top:18px" class="small">
          <strong id="productCount">0</strong> products â€¢ Safe checkout â€¢ COD available
        </div>
      </div>

      <div class="hero-banner" aria-hidden="true">
        <img id="heroImage" src="https://via.placeholder.com/720x420?text=ONLINETRADERZ" alt="Featured product banner" />
      </div>
    </section>

    <!-- Products -->
    <section id="shop" style="margin-top:18px">
      <div class="section-head">
        <h2 style="margin:0">Featured Products</h2>
        <div class="small">Showing <strong id="productCountTop">0</strong></div>
      </div>

      <div id="productsGrid" class="products-grid" aria-live="polite" aria-atomic="true">
        <!-- cards inserted here -->
      </div>

      <div id="pagination" class="pagination" role="navigation" aria-label="Pagination"></div>
    </section>

    <!-- Footer -->
    <footer id="contact" class="site-footer" role="contentinfo">
      <div style="display:flex;flex-direction:column;gap:10px;align-items:center">
        <div>Email: <a href="mailto:farisdaar107@gmail.com">farisdaar107@gmail.com</a> â€¢ WhatsApp: <a href="https://wa.me/923444318078" target="_blank" rel="noopener">+92 344 4318078</a></div>
        <div style="font-size:13px;color:var(--muted)">Â© ONLINETRADERZ â€” Built with care</div>
      </div>
    </footer>
  </main>

  <!-- Product Details Modal -->
  <div id="productDetails" class="modal" role="dialog" aria-hidden="true" aria-labelledby="detailTitle">
    <div class="modal-card" role="document">
      <button class="close" aria-label="Close product details" onclick="closeProductDetails()">&times;</button>
      <div style="display:flex;gap:20px;flex-wrap:wrap;">
        <div style="flex:1;min-width:220px">
          <div style="border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#f8fafc,#fff);padding:8px">
            <img id="detailImg" src="https://via.placeholder.com/420" alt="Product image" style="width:100%;height:320px;object-fit:contain;border-radius:8px" />
          </div>
        </div>
        <div style="flex:1.1;min-width:260px">
          <h2 id="detailTitle" style="margin-top:4px"></h2>
          <div id="detailPrice" style="font-weight:900;margin:8px 0;font-size:1.2rem"></div>
          <div id="detailDescription" class="meta-muted"></div>

          <div style="display:flex;gap:10px;margin-top:16px">
            <button id="detailAddBtn" class="btn btn-primary">Add to Cart</button>
            <a id="detailWhatsApp" class="btn wa-btn" style="display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:var(--text)" target="_blank" rel="noopener">WhatsApp</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="cartHeading">
    <div class="modal-card" role="document">
      <button class="close" aria-label="Close cart" onclick="closeCart()">&times;</button>
      <h3 id="cartHeading">Your Cart</h3>

      <ul id="cartItems" class="cart-list" style="margin-top:12px"></ul>

      <div style="display:flex;justify-content:flex-end;gap:18px;margin-top:12px;flex-wrap:wrap">
        <div style="min-width:220px">
          <div class="small">Subtotal</div>
          <div style="font-weight:900">RS.<span id="cartSubtotal">0</span></div>
          <div class="small" style="margin-top:6px">Delivery: RS.<span id="cartDelivery">0</span></div>
          <div style="margin-top:8px;font-size:18px;font-weight:900">Total: RS.<span id="cartTotal">0</span></div>
        </div>

        <div style="min-width:220px;display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-primary checkout-btn" onclick="checkout()">Checkout (COD)</button>
          <button class="btn btn-ghost" onclick="clearCart()">Clear Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Modal -->
  <div id="orderModal" class="modal" role="dialog" aria-hidden="true" aria-labelledby="orderHeading">
    <div class="modal-card" role="document">
      <button class="close" aria-label="Close order form" onclick="closeOrderForm()">&times;</button>
      <h3 id="orderHeading">Order Submission</h3>

      <form id="orderForm" style="margin-top:12px" onsubmit="submitOrder(event)">
        <input id="orderName" required placeholder="Full Name" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-2);margin-bottom:10px" />
        <input id="orderContact" required placeholder="Contact Number" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-2);margin-bottom:10px" />
        <input id="orderEmail" placeholder="Email (optional)" type="email" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-2);margin-bottom:10px" />
        <textarea id="orderAddress" required placeholder="Full Address" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-2);margin-bottom:10px;min-height:120px"></textarea>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn btn-primary" type="submit">Submit Order</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ============================
   API / State (unchanged behavior)
   ============================ */

/* Keep your API base â€” change as you already had in original file */
const API_BASE = "https://cppbackened.onrender.com";

/* Local state */
let allProducts = [];
let currentPage = 1;
const productsPerPage = 12;
let cart = [];

/* -------------------------
   Helpers & UI Utilities
   ------------------------- */
function scrollToProducts(){ document.getElementById('shop').scrollIntoView({behavior:'smooth'}); }

function showPreloader(hide=false){
  const p = document.getElementById('preloader');
  if(!p) return;
  if(hide){
    p.style.opacity = '0';
    p.setAttribute('aria-hidden','true');
    setTimeout(()=>{ p.style.display = 'none'; }, 350);
  } else {
    p.style.display = 'flex';
    p.style.opacity = '1';
    p.setAttribute('aria-hidden','false');
  }
}

/* -------------------------
   Theme (hybrid auto + toggle)
   ------------------------- */
const themeToggleBtn = document.getElementById('themeToggle');

function applyTheme(t){
  document.body.classList.remove('theme-dark');
  if(t === 'dark') document.body.classList.add('theme-dark');
  // persist choice
  try { localStorage.setItem('ot_theme', t); } catch(e){}
}

function detectSystemTheme(){
  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) return 'dark';
  return 'light';
}

function initTheme(){
  let saved = null;
  try { saved = localStorage.getItem('ot_theme'); } catch(e){}
  const theme = saved || detectSystemTheme();
  applyTheme(theme);
  themeToggleBtn.textContent = theme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
}
themeToggleBtn.addEventListener('click', ()=>{
  const isDark = document.body.classList.contains('theme-dark');
  const next = isDark ? 'light' : 'dark';
  applyTheme(next);
  themeToggleBtn.textContent = next === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
});

/* -------------------------
   Product details modal
   ------------------------- */
function viewDetails(id){
  const p = allProducts.find(x=>x.id===id);
  if(!p) return;
  document.getElementById('detailImg').src = p.img || 'https://via.placeholder.com/420';
  document.getElementById('detailTitle').textContent = p.title || '';
  document.getElementById('detailPrice').textContent = `RS.${(Number(p.price||0)).toFixed(2)}`;
  document.getElementById('detailDescription').textContent = p.description || 'No description available.';
  document.getElementById('detailWhatsApp').href = `https://wa.me/923444318078?text=${encodeURIComponent("I'm interested in " + (p.title||''))}`;
  document.getElementById('detailAddBtn').onclick = ()=>{ addToCart(p.id); closeProductDetails(); openCart(); };
  document.getElementById('productDetails').classList.add('open');
}
function closeProductDetails(){ document.getElementById('productDetails').classList.remove('open'); }

/* -------------------------
   Load products from backend
   ------------------------- */
async function loadProducts(){
  showPreloader(false);
  try{
    const res = await fetch(API_BASE + "/api/products");
    if(!res.ok) throw new Error('Failed to fetch products: ' + res.status);
    allProducts = await res.json();

    // Normalize product objects & convert relative image paths to absolute (like original behaviour)
    allProducts = allProducts.map(p=>{
      p = p || {};
      const id = p.id || p._id || (p.title ? p.title.replace(/\s+/g,'-').toLowerCase() : String(Math.random()).slice(2,8));
      let img = p.img || '';
      if (typeof img === 'string') {
        img = img.trim();
        if (img) {
          if (img.startsWith('public/')) img = img.replace(/^public\//, '');
          if (!img.startsWith('http')) {
            if (!img.startsWith('/')) img = '/' + img;
            img = API_BASE + img;
          }
        }
      } else {
        img = '';
      }
      return {...p, id, img};
    });

    document.getElementById('productCount').textContent = allProducts.length;
    document.getElementById('productCountTop').textContent = allProducts.length;
    renderProducts();
    renderPagination();
  }catch(err){
    console.error(err);
    const container = document.getElementById('productsGrid');
    container.innerHTML = '<div style="padding:20px;color:#b91c1c">Failed to load products. Check server URL and CORS.</div>';
  } finally {
    // slightly delay so preloader doesn't flash too briefly
    setTimeout(()=>showPreloader(true), 220);
  }
}

/* -------------------------
   Render products
   ------------------------- */
function renderProducts(){
  const container = document.getElementById('productsGrid');
  container.innerHTML = '';
  const start = (currentPage - 1) * productsPerPage;
  const pageProducts = allProducts.slice(start, start + productsPerPage);

  pageProducts.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    // escape title & description safely
    const title = escapeHtml(p.title || '');
    const desc = escapeHtml(p.description || '');
    const price = Number(p.price || 0).toFixed(2);
    const img = p.img || 'https://via.placeholder.com/420';

    card.innerHTML = `
      <div class="img-wrap" role="button" tabindex="0" aria-label="View ${title}">
        <img src="${img}" alt="${title}">
      </div>
      <h3>${title}</h3>
      <div class="price">RS.${price}</div>
      <div class="meta-muted">${desc}</div>
      <div class="actions">
        <button class="add-btn" aria-label="Add ${title} to cart">Add to Cart</button>
        <button class="wa-btn" aria-label="Contact about ${title}">WhatsApp</button>
      </div>
    `;

    // interactive bits
    const imgWrap = card.querySelector('.img-wrap');
    imgWrap.addEventListener('click', ()=>viewDetails(p.id));
    imgWrap.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') viewDetails(p.id); });

    const addBtn = card.querySelector('.add-btn');
    addBtn.addEventListener('click', ()=>addToCart(p.id));

    const waBtn = card.querySelector('.wa-btn');
    waBtn.addEventListener('click', ()=> window.open(`https://wa.me/923444318078?text=${encodeURIComponent('I am interested in ' + (p.title||''))}`, '_blank'));

    container.appendChild(card);
  });

  // if grid empty, show friendly message
  if(pageProducts.length === 0){
    container.innerHTML = '<div style="padding:28px;color:var(--muted);text-align:center">No products available.</div>';
  }
}

/* -------------------------
   Pagination
   ------------------------- */
function renderPagination(){
  const container = document.getElementById('pagination');
  container.innerHTML = '';
  const totalPages = Math.max(1, Math.ceil(allProducts.length / productsPerPage));
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i===currentPage){ btn.disabled = true; btn.style.fontWeight='900'; }
    btn.onclick = ()=>{ currentPage = i; renderProducts(); renderPagination(); window.scrollTo({top:220,behavior:'smooth'}); };
    container.appendChild(btn);
  }
}

/* -------------------------
   Cart operations
   ------------------------- */
function addToCart(id){
  const product = allProducts.find(p=>p.id===id);
  if(!product) return;
  const existing = cart.find(i=>i.id===id);
  if(existing){ existing.qty += 1; } else { cart.push({...product, qty:1}); }
  updateCartUI();
}

function removeFromCart(id){
  cart = cart.filter(i=>i.id!==id);
  updateCartUI();
}

function changeQty(id, delta){
  const item = cart.find(i=>i.id===id);
  if(!item) return;
  item.qty += delta;
  if(item.qty <= 0) removeFromCart(id);
  updateCartUI();
}

function clearCart(){
  if(!confirm('Clear cart?')) return;
  cart = [];
  updateCartUI();
}

function getDeliveryCharges(subtotal){
  if(subtotal > 0 && subtotal < 3000) return 180;
  if(subtotal >= 3000 && subtotal < 5000) return 550;
  if(subtotal >= 5000) return 0;
  return 0;
}

function updateCartUI(){
  const cartCountEl = document.getElementById('cartCount');
  cartCountEl.textContent = cart.reduce((s,i)=>s+i.qty,0);

  const list = document.getElementById('cartItems');
  list.innerHTML = '';

  let subtotal = 0;
  cart.forEach(i=>{
    subtotal += (Number(i.price || 0) * i.qty);
    const li = document.createElement('li');
    li.className = 'cart-item';
    const title = escapeHtml(i.title || '');
    const itemTotal = (Number(i.price||0) * i.qty).toFixed(2);
    li.innerHTML = `
      <img src="${i.img || 'https://via.placeholder.com/420'}" alt="${title}">
      <div style="flex:1">
        <div style="font-weight:800">${title}</div>
        <div style="color:var(--muted);font-size:13px">RS.${itemTotal}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="qty-controls">
          <button onclick="changeQty('${i.id}', -1)" aria-label="Decrease quantity">-</button>
          <div style="min-width:30px;text-align:center">${i.qty}</div>
          <button onclick="changeQty('${i.id}', 1)" aria-label="Increase quantity">+</button>
        </div>
        <button style="background:transparent;border:0;color:#b91c1c;cursor:pointer" onclick="removeFromCart('${i.id}')">Remove</button>
      </div>
    `;
    list.appendChild(li);
  });

  const deliveryCharges = getDeliveryCharges(subtotal);
  const total = subtotal + deliveryCharges;

  document.getElementById('cartSubtotal').textContent = subtotal.toFixed(2);
  document.getElementById('cartDelivery').textContent = deliveryCharges === 0 ? 'Free' : deliveryCharges.toFixed(2);
  document.getElementById('cartTotal').textContent = total.toFixed(2);
}

/* -------------------------
   Modals open/close
   ------------------------- */
function openCart(){ updateCartUI(); document.getElementById('cartModal').classList.add('open'); }
function closeCart(){ document.getElementById('cartModal').classList.remove('open'); }
function checkout(){ if(cart.length===0) return alert('Cart is empty.'); closeCart(); document.getElementById('orderModal').classList.add('open'); }
function closeOrderForm(){ document.getElementById('orderModal').classList.remove('open'); }

/* -------------------------
   Order submission (POST /api/orders)
   ------------------------- */
function submitOrder(event){
  event.preventDefault();
  const name = document.getElementById('orderName').value.trim();
  const contact = document.getElementById('orderContact').value.trim();
  const email = document.getElementById('orderEmail').value.trim();
  const address = document.getElementById('orderAddress').value.trim();
  if(!name || !contact || !address) return alert('All fields required!');

  const productsData = cart.map(p=>({ product: p.id, qty: p.qty }));

  fetch(API_BASE + "/api/orders", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ products: productsData, name, contact, email, address })
  })
  .then(res => {
    // server returns JSON like {status:"success", message:"...", orderId:"O1"}
    try { return res.json(); } catch(e){ return res.text(); }
  })
  .then(data=>{
    if(typeof data === 'object' && data !== null && (data.status === 'success' || (data.message && data.message.toLowerCase().includes('success')))) {
      alert(`Thank you ${name}! Your order has been placed successfully. Order ID: ${data.orderId || ''}`);
      // open whatsapp summary to confirm
      const message = `Hello ${name}, your order for ${cart.map(p=>p.title+' x'+p.qty).join(', ')} has been received. Order ID: ${data.orderId || ''}`;
      window.open(`https://wa.me/${contact}?text=${encodeURIComponent(message)}`, '_blank');

      // clear cart, update UI and close
      cart = [];
      updateCartUI();
      closeOrderForm();
    } else if (typeof data === 'string' && data.toLowerCase().includes('order placed')) {
      // fallback for older behavior
      alert(`Thank you ${name}! Your order has been placed successfully.`);
      cart = []; updateCartUI(); closeOrderForm();
    } else {
      console.error('Order error response: ', data);
      alert('Failed to place order. Please try again.');
    }
  })
  .catch(err=>{
    console.error(err);
    alert('Error connecting to server.');
  });
}

/* -------------------------
   Escape helper (safe)
   ------------------------- */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* -------------------------
   Init on load
   ------------------------- */
window.addEventListener('load', ()=>{
  initTheme();
  loadProducts();
});

/* close modals on Escape */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
  }
});

/* Accessibility: close preloader if user presses any key (graceful) */
document.addEventListener('keydown', ()=>{ document.getElementById('preloader') && document.getElementById('preloader').style.display === 'flex' && document.getElementById('preloader').style.display !== 'none' && document.getElementById('preloader').style.opacity !== '0' && showPreloader(true); });

</script>
</body>
</html>
