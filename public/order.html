<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Orders</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav a { margin-right: 20px; text-decoration: none; font-weight: bold; }
    h1 { margin-bottom: 20px; }
    #orders { margin-top: 20px; border-collapse: collapse; width: 100%; }
    #orders th, #orders td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    #orders th { background: #f4f4f4; }
    form { margin-top: 40px; max-width: 400px; }
    form input, form textarea, form select { display: block; margin: 10px 0; padding: 8px; width: 100%; }
    form button { padding: 10px; background: #28a745; color: #fff; border: none; cursor: pointer; }
    form button:hover { background: #218838; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Products</a>
    <a href="orders.html">Orders</a>
  </nav>

  <h1>Orders</h1>

  <table id="orders">
    <thead>
      <tr>
        <th>Product</th>
        <th>Name</th>
        <th>Contact</th>
        <th>Email</th>
        <th>Address</th>
        <th>Total</th>
        <th>Payment</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Place Order</h2>
  <form id="orderForm">
    <label for="product">Select Product:</label>
    <select name="product" id="product" required></select>

    <input type="text" name="name" placeholder="Your Name" required />
    <input type="text" name="contact" placeholder="Contact Number" required />
    <input type="email" name="email" placeholder="Email" required />
    <textarea name="address" placeholder="Delivery Address" required></textarea>
    
    <!-- No manual total/payment input, backend calculates -->
    <button type="submit">Submit Order</button>
  </form>

  <script>
    async function loadProducts() {
      try {
        const res = await fetch('/api/products');
        const products = await res.json();
        const select = document.getElementById('product');
        select.innerHTML = '';
        products.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id; // send product ID to backend
          option.textContent = `${p.title} (Rs.${p.price})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to load products:', err);
      }
    }

    async function loadOrders() {
      try {
        const res = await fetch('/api/orders');
        const orders = await res.json();
        const tbody = document.querySelector('#orders tbody');
        tbody.innerHTML = '';
        orders.forEach(o => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${o.product}</td>
            <td>${o.name}</td>
            <td>${o.contact}</td>
            <td>${o.email}</td>
            <td>${o.address}</td>
            <td>Rs.${o.totalAmount}</td>
            <td>${o.payment}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Failed to load orders:', err);
      }
    }

    async function submitOrder(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        product: form.product.value, // product ID
        name: form.name.value,
        contact: form.contact.value,
        email: form.email.value,
        address: form.address.value
      };
      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const text = await res.text();
        alert(text);
        form.reset();
        loadOrders();
        loadProducts(); // reload in case stock updates
      } catch (err) {
        console.error('Failed to submit order:', err);
      }
    }

    document.getElementById('orderForm').addEventListener('submit', submitOrder);
    window.onload = () => {
      loadProducts();
      loadOrders();
    };
  </script>
</body>
</html>
