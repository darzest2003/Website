        <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Products & Orders</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f9; }
    .container { max-width: 1200px; margin: auto; padding: 20px; }
    h1 { color: #333; text-align: center; margin-bottom: 20px; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: #343a40; color: white; padding: 15px 20px; }
    .logout-btn { background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
    .logout-btn:hover { background: #c82333; }
    form { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, button, select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #28a745; color: white; border: none; cursor: pointer; margin-top: 15px; }
    button:hover { background: #218838; }
    .section { margin-top: 30px; }
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .list-header input { width: 200px; }
    .product, .order { background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; }
    .product img { width: 80px; height: 80px; object-fit: cover; margin-right: 15px; border-radius: 5px; }
    .actions { margin-left: auto; }
    .actions button { background: #dc3545; margin-left: 5px; }
    .actions button:hover { background: #c82333; }
    .order-details { flex: 1; }
    .order-actions button { background: #007bff; }
    .order-actions button:hover { background: #0056b3; }
    .export-btn { background: #17a2b8; }
    .export-btn:hover { background: #117a8b; }
    /* hidden canvases for barcodes */
    #barcodeCanvasCustomer, #barcodeCanvasSeller { display:none; }
  </style>
</head>
<body>
  <script>
    if (sessionStorage.getItem("adminLoggedIn") !== "true") {
      window.location.href = "admin_login.html";
    }
    window.addEventListener("beforeunload", function() {
      sessionStorage.removeItem("adminLoggedIn");
    });
  </script>

  <div class="top-bar">
    <h2>Admin Dashboard</h2>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="container">

    <!-- Product Form -->
    <form id="productForm">
      <h3>Add New Product</h3>
      <label>Title:</label>
      <input type="text" id="title" required>
      <label>Price:</label>
      <input type="number" id="price" required>
      <label>Image Path (relative to /uploads/):</label>
      <input type="text" id="img" placeholder="e.g. uploads/shirt.jpg" required>
      <label>Stock:</label>
      <input type="number" id="stock" required>
      <button type="submit">Add Product</button>
    </form>

    <!-- Products List -->
    <div class="section">
      <div class="list-header">
        <h3>Products</h3>
        <input type="text" id="productSearch" placeholder="Search products...">
      </div>
      <div id="productList"></div>
    </div>

    <!-- Orders List -->
    <div class="section">
      <div class="list-header">
        <h3>Orders</h3>
        <div>
          <input type="text" id="orderSearch" placeholder="Search orders...">
          <button class="export-btn" onclick="exportOrders()">Export CSV</button>
        </div>
      </div>
      <div id="orderList"></div>
    </div>
  </div>

  <canvas id="barcodeCanvasCustomer"></canvas>
  <canvas id="barcodeCanvasSeller"></canvas>

  <script>
    const API_BASE = "https://cppbackened.onrender.com";

    function logout() {
      sessionStorage.removeItem("adminLoggedIn");
      window.location.href = "admin_login.html";
    }

    async function loadProducts() {
      try {
        const res = await fetch(`${API_BASE}/api/products`);
        const products = await res.json();
        window.productsCache = products;
        displayProducts(products);
      } catch (err) { console.error("Failed to load products", err); }
    }

    function displayProducts(products) {
      const search = document.getElementById("productSearch").value.toLowerCase();
      const container = document.getElementById("productList");
      container.innerHTML = "";
      products.filter(p => p.title.toLowerCase().includes(search)).forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <img src="${p.img}" alt="${p.title}">
          <div>
            <h4>${p.title}</h4>
            <p>Price: RS.${p.price}</p>
            <p>Stock: ${p.stock}</p>
          </div>
          <div class="actions">
            <button onclick="deleteProduct('${p.id}')">Delete</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById("productSearch").addEventListener("input", () => displayProducts(window.productsCache));

    document.getElementById("productForm").onsubmit = async function(e) {
      e.preventDefault();
      const product = {
        title: document.getElementById("title").value.trim(),
        price: document.getElementById("price").value,
        img: document.getElementById("img").value.trim(),
        stock: document.getElementById("stock").value
      };
      try {
        const res = await fetch(`${API_BASE}/api/addProduct`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(product)
        });
        alert(await res.text());
        loadProducts();
        this.reset();
      } catch (err) { console.error("Error adding product", err); }
    };

    async function deleteProduct(id) {
      if (!confirm("Are you sure you want to delete this product?")) return;
      try {
        const res = await fetch(`${API_BASE}/api/deleteProduct`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        alert(await res.text());
        loadProducts();
      } catch (err) { console.error("Error deleting product", err); }
    }

    async function loadOrders() {
      try {
        const res = await fetch(`${API_BASE}/api/orders`);
        const orders = await res.json();
        window.ordersCache = orders;
        displayOrders(orders);
      } catch (err) { console.error("Failed to load orders", err); }
    }

    function displayOrders(orders) {
      const search = document.getElementById("orderSearch").value.toLowerCase();
      const container = document.getElementById("orderList");
      container.innerHTML = "";
      orders.filter(o => o.name.toLowerCase().includes(search) || o.contact.includes(search)).forEach((o, i) => {
        const div = document.createElement("div");
        div.className = "order";
        div.innerHTML = `
          <div class="order-details">
            <p><b>Product:</b> ${o.product}</p>
            <p><b>Name:</b> ${o.name}</p>
            <p><b>Contact:</b> ${o.contact}</p>
            <p><b>Email:</b> ${o.email}</p>
            <p><b>Address:</b> ${o.address}</p>
            <p><b>Total:</b> RS.${o.totalAmount}</p>
            <p><b>Payment:</b> ${o.payment}</p>
          </div>
          <div class="order-actions">
            <button onclick="downloadLabel(${i})">Label</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById("orderSearch").addEventListener("input", () => displayOrders(window.ordersCache));

    function exportOrders() {
      const rows = [["Product","Name","Contact","Email","Address","Total","Payment"]];
      window.ordersCache.forEach(o => rows.push([o.product,o.name,o.contact,o.email,o.address,o.totalAmount,o.payment]));
      let csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "orders.csv";
      link.click();
    }

    function generateBarcode(text, canvasId) {
      const canvas = document.getElementById(canvasId);
      JsBarcode(canvas, text, { format: "CODE128", width: 2, height: 50, displayValue: true });
      return canvas.toDataURL("image/png");
    }

    function downloadLabel(index) {
      const o = window.ordersCache[index];
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica","bold"); doc.setFontSize(18);
      doc.text("SHIPPING DETAILS", 70, 20);

      // Rectangle border
      doc.setFont("helvetica","normal"); doc.setFontSize(12);
      doc.rect(20,30,170,160);

      // Customer details
      doc.text(`Product: ${o.product}`,25,40);
      doc.text(`Name: ${o.name}`,25,50);
      doc.text(`Contact: ${o.contact}`,25,60);
      doc.text(`Email: ${o.email}`,25,70);
      doc.text(`Address: ${o.address}`,25,80);
      doc.text(`Total: RS.${o.totalAmount}`,25,100);
      doc.text(`Payment: ${o.payment}`,25,110);

      // Seller/shipper details
      doc.text("From: Onlinetraderz",25,130);
      doc.text("Support: 923187900076",25,140);

      // Barcodes
      const customerBarcode = generateBarcode(o.contact, "barcodeCanvasCustomer");
      doc.addImage(customerBarcode, "PNG", 25, 150, 100, 25);

      const sellerBarcode = generateBarcode("923187900076", "barcodeCanvasSeller");
      doc.addImage(sellerBarcode, "PNG", 25, 185, 100, 25);

      doc.save(`label_${index+1}.pdf`);
    }

    loadProducts();
    loadOrders();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</body>
</html>
