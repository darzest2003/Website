<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ONLINETRADERZ — Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; margin:0; background:#f4f6f8; }
.topbar { background:#111; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
.topbar h2 { margin:0; }
.topbar button { background:#333; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:4px; }
.topbar button:hover { background:#555; }

.sidebar { position:fixed; top:50px; left:0; width:220px; bottom:0; background:#1e1e1e; color:#fff; padding:10px; overflow-y:auto; }
.sidebar li { list-style:none; padding:12px; cursor:pointer; }
.sidebar li:hover, .sidebar li.active { background:#333; }

.main { margin-left:240px; padding:20px; }
.card { background:#fff; padding:20px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.1); margin-bottom:15px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:15px; }

input, button { padding:10px; margin:5px 0; width:100%; box-sizing:border-box; }
button { cursor:pointer; border:none; border-radius:4px; }
button.add { background:#25D366; color:#fff; }
button.update { background:#007bff; color:#fff; }
button.delete { background:#dc3545; color:#fff; }

.product img { width:100%; height:150px; object-fit:cover; border-radius:6px; margin-bottom:10px; }

.toast { position:fixed; bottom:20px; right:20px; background:#111; color:#fff; padding:12px 18px; border-radius:4px; opacity:0; transition:.3s; z-index:1000; }
.toast.show { opacity:1; }
</style>
</head>
<body>

<div class="topbar">
  <h2>Admin Dashboard</h2>
  <button onclick="logout()">Logout</button>
</div>

<ul class="sidebar">
  <li data-page="dashboard" onclick="location.href='admin.html'">Dashboard</li>
  <li class="active" data-page="products">Products</li>
  <li data-page="orders" onclick="location.href='admin.html#orders'">Orders</li>
</ul>

<div class="main">

  <div class="card">
    <h3>Add Product</h3>
    <input type="text" id="pTitle" placeholder="Product Title">
    <input type="number" id="pPrice" placeholder="Price">
    <input type="number" id="pStock" placeholder="Stock">
    <input type="text" id="pImg" placeholder="Image URL">
    <button class="add" onclick="addProduct()">Add Product</button>
  </div>

  <h3>All Products</h3>
  <div class="grid" id="productList"></div>

</div>

<div class="toast" id="toast"></div>

<script>
const API = "https://cppbackened.onrender.com";

/* ===== AUTH ===== */
if(sessionStorage.getItem("adminLoggedIn")!=="true"){ location.href="admin_login.html"; }
function logout(){ sessionStorage.clear(); location.href="admin_login.html"; }

/* ===== TOAST ===== */
function toast(msg){ 
  const t = document.getElementById("toast"); 
  t.textContent = msg; 
  t.classList.add("show"); 
  setTimeout(()=>t.classList.remove("show"),2500); 
}

/* ===== LOAD PRODUCTS ===== */
async function loadProducts(){
  try{
    const res = await fetch(`${API}/api/products`);
    const products = await res.json();
    renderProducts(products);
  }catch(e){ console.error(e); toast("Failed to load products"); }
}

/* ===== RENDER PRODUCTS ===== */
function renderProducts(products){
  const container = document.getElementById("productList");
  container.innerHTML = "";
  products.forEach(p=>{
    const div = document.createElement("div");
    div.className = "card product";
    div.innerHTML = `
      <img src="${p.img || 'https://via.placeholder.com/200'}" alt="${p.title}">
      <input type="text" id="title_${p.id}" value="${p.title}">
      <input type="number" id="price_${p.id}" value="${p.price}">
      <input type="number" id="stock_${p.id}" value="${p.stock}">
      <input type="text" id="img_${p.id}" value="${p.img}">
      <button class="update" onclick="updateProduct('${p.id}')">Update</button>
      <button class="delete" onclick="deleteProduct('${p.id}')">Delete</button>
    `;
    container.appendChild(div);
  });
}

/* ===== ADD PRODUCT ===== */
async function addProduct(){
  const title = document.getElementById("pTitle").value.trim();
  const price = Number(document.getElementById("pPrice").value || 0);
  const stock = Number(document.getElementById("pStock").value || 0);
  const img = document.getElementById("pImg").value.trim();
  if(!title || !price || !stock || !img){ toast("Fill all fields"); return; }

  const newProduct = { id:"p_"+Math.random().toString(36).slice(2,9), title, price, stock, img };

  try{
    const existing = await (await fetch(`${API}/api/products`)).json();
    const products = [...existing, newProduct];
    const res = await fetch(`${API}/api/products`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(products) });
    if(!res.ok) throw 1;
    toast("✅ Product added");
    document.getElementById("pTitle").value="";
    document.getElementById("pPrice").value="";
    document.getElementById("pStock").value="";
    document.getElementById("pImg").value="";
    loadProducts();
  }catch(e){ console.error(e); toast("Failed to add product"); }
}

/* ===== UPDATE PRODUCT ===== */
async function updateProduct(id){
  try{
    const title = document.getElementById(`title_${id}`).value.trim();
    const price = Number(document.getElementById(`price_${id}`).value || 0);
    const stock = Number(document.getElementById(`stock_${id}`).value || 0);
    const img = document.getElementById(`img_${id}`).value.trim();

    const products = await (await fetch(`${API}/api/products`)).json();
    const index = products.findIndex(p=>p.id===id);
    if(index<0) return toast("Product not found");

    products[index] = {...products[index], title, price, stock, img};
    await fetch(`${API}/api/products`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(products) });
    toast("✅ Product updated");
    loadProducts();
  }catch(e){ console.error(e); toast("Failed to update product"); }
}

/* ===== DELETE PRODUCT ===== */
async function deleteProduct(id){
  try{
    const products = await (await fetch(`${API}/api/products`)).json();
    const filtered = products.filter(p=>p.id!==id);
    await fetch(`${API}/api/products`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(filtered) });
    toast("✅ Product deleted");
    loadProducts();
  }catch(e){ console.error(e); toast("Failed to delete product"); }
}

/* ===== INIT ===== */
loadProducts();
</script>
</body>
</html>
